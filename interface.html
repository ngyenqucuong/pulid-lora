<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDXL Face Swap Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'glass-bg': 'rgba(255, 255, 255, 0.25)',
                        'glass-border': 'rgba(255, 255, 255, 0.18)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .glass-card-secondary {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(31, 38, 135, 0.2);
        }
        
        .upload-zone {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .upload-zone:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .input-glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #1a202c;
        }
        
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-glass::placeholder {
            color: rgba(31, 41, 55, 0.6);
        }
        
        .slider-modern {
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            outline: none;
        }
        
        .slider-modern::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #1a202c;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .progress-modern {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar-modern {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            transition: all 0.3s ease;
            transform: translateY(20px);
            opacity: 0;
            animation: slideInUp 0.5s ease forwards;
        }
        
        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(31, 38, 135, 0.3);
        }
        
        @keyframes slideInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .section-title {
            color: #1a202c;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .label-modern {
            color: #374151;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .value-display {
            color: #6b7280;
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .header-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.4);
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="header-card p-8 mb-8 text-center">
            <h1 class="text-5xl font-bold text-gray-800 mb-3">
                üé≠ SDXL Face Swap Studio
            </h1>
            <p class="text-gray-600 text-lg font-medium">
                Generate stunning AI images with advanced face swapping technology
            </p>
        </div>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Controls Panel -->
            <div class="xl:col-span-2 space-y-6">
                <!-- Image Upload Card -->
                <div class="glass-card p-6">
                    <h3 class="section-title">üì∑ Image Upload</h3>
                    <div class="upload-zone p-8 text-center cursor-pointer" onclick="document.getElementById('baseImage').click()">
                        <input type="file" id="baseImage" accept="image/*" class="hidden">
                        <div id="baseImagePreview" class="hidden">
                            <img id="baseImageImg" class="max-w-full h-40 object-cover rounded-xl mx-auto shadow-lg">
                        </div>
                        <div id="baseImagePlaceholder" class="space-y-3">
                            <div class="text-6xl">üì∏</div>
                            <div class="text-gray-700 font-semibold">Click to upload your base image</div>
                            <div class="text-gray-500 text-sm">Supports JPG, PNG, WebP</div>
                        </div>
                    </div>
                </div>

                <!-- Prompt Card -->
                <div class="glass-card p-6">
                    <h3 class="section-title">‚ú® Creative Prompt</h3>
                    <textarea id="Prompt" 
                            class="w-full p-4 input-glass text-gray-800 placeholder-gray-500"
                            rows="3" 
                            placeholder="Describe your vision: natural head with hair, detailed hairstyle, photorealistic portrait..."></textarea>
                </div>

                <!-- Parameters Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- AI Settings -->
                    <div class="glass-card p-6">
                        <h3 class="section-title">ü§ñ AI Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block label-modern">Sequence Length</label>
                                <input type="range" id="maxSequenceLength" min="128" max="512" step="128" value="128" 
                                       class="w-full slider-modern" oninput="document.getElementById('maxSequenceLengthValue').textContent = this.value">
                                <div class="flex justify-between mt-2">
                                    <span class="value-display">Fast</span>
                                    <span id="maxSequenceLengthValue" class="value-display font-semibold">128</span>
                                    <span class="value-display">Quality</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block label-modern">ID Weight</label>
                                <input type="range" id="idWeightScale" min="0" max="3" step="0.05" value="1" 
                                       class="w-full slider-modern" oninput="document.getElementById('idWeightScaleValue').textContent = this.value">
                                <div class="flex justify-between mt-2">
                                    <span class="value-display">Low</span>
                                    <span id="idWeightScaleValue" class="value-display font-semibold">1</span>
                                    <span class="value-display">High</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Settings -->
                    <div class="glass-card p-6">
                        <h3 class="section-title">‚öôÔ∏è Generation</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block label-modern">CFG Scale</label>
                                <input type="range" id="cfgScale" min="1" max="10" step="0.1" value="1" 
                                       class="w-full slider-modern" oninput="document.getElementById('cfgScaleValue').textContent = this.value">
                                <span id="cfgScaleValue" class="value-display font-semibold">1</span>
                            </div>
                            
                            <div>
                                <label class="block label-modern">Timestep CFG</label>
                                <input type="range" id="timestepToStartCfg" min="1" max="10" step="0.1" value="1" 
                                       class="w-full slider-modern" oninput="document.getElementById('timestepToStartCfgValue').textContent = this.value">
                                <span id="timestepToStartCfgValue" class="value-display font-semibold">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="glass-card p-6">
                    <h3 class="section-title">üéõÔ∏è Advanced Controls</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block label-modern">Width</label>
                            <input type="range" id="width" min="256" max="1536" step="16" value="896" 
                                   class="w-full slider-modern" oninput="document.getElementById('widthValue').textContent = this.value">
                            <span id="widthValue" class="value-display font-semibold">896</span>
                        </div>
                        <div>
                            <label class="block label-modern">Height</label>
                            <input type="range" id="height" min="256" max="1536" step="16" value="1152" 
                                   class="w-full slider-modern" oninput="document.getElementById('heightValue').textContent = this.value">
                            <span id="heightValue" class="value-display font-semibold">1152</span>
                        </div>
                        <div>
                            <label class="block label-modern">Guidance</label>
                            <input type="range" id="guidanceScale" min="1" max="10" step="0.1" value="4" 
                                   class="w-full slider-modern" oninput="document.getElementById('guidanceScaleValue').textContent = this.value">
                            <span id="guidanceScaleValue" class="value-display font-semibold">4</span>
                        </div>
                        <div>
                            <label class="block label-modern">Steps</label>
                            <input type="range" id="numStep" min="0" max="30" step="1" value="8" 
                                   class="w-full slider-modern" oninput="document.getElementById('numStepValue').textContent = this.value">
                            <span id="numStepValue" class="value-display font-semibold">8</span>
                        </div>
                        <div>
                            <label class="block label-modern">Start Step</label>
                            <input type="range" id="startStep" min="0" max="10" step="1" value="0" 
                                   class="w-full slider-modern" oninput="document.getElementById('startStepValue').textContent = this.value">
                            <span id="startStepValue" class="value-display font-semibold">0</span>
                        </div>
                        <div>
                            <label class="block label-modern">Seed</label>
                            <input type="number" id="generateSeed" 
                                   class="w-full p-2 input-glass text-sm" 
                                   value="-1" placeholder="-1">
                        </div>
                    </div>
                </div>

                <!-- Generate Button & Progress -->
                <div class="glass-card p-6">
                    <button id="generateBtn" 
                            class="w-full btn-primary py-4 px-6 text-lg font-bold">
                        üöÄ Generate Amazing Image
                    </button>

                    <!-- Progress Section -->
                    <div id="progressSection" class="mt-6 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-700 font-semibold">Creating your masterpiece...</span>
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="progress-modern">
                            <div id="progressBar" class="progress-bar-modern w-0"></div>
                        </div>
                        <div id="progressText" class="text-gray-600 text-sm mt-2 font-medium">Initializing...</div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="xl:col-span-1 space-y-6">
                <!-- Results Card -->
                <div class="glass-card p-6 h-fit">
                    <h3 class="section-title">üé® Your Creations</h3>
                    
                    <div id="resultsContainer" class="space-y-4">
                        <div id="noResults" class="text-center py-12">
                            <div class="text-6xl mb-4 opacity-60">üñºÔ∏è</div>
                            <p class="text-gray-600 font-medium">Your masterpieces will appear here</p>
                            <p class="text-gray-500 text-sm mt-2">Upload an image and start creating!</p>
                        </div>
                    </div>
                </div>

                <!-- Job History Card -->
                <div class="glass-card p-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">üìã Recent Jobs</h4>
                    <div id="jobHistory" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Jobs will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentJobs = new Set();
        
        // Setup file input for base image
        const baseInput = document.getElementById('baseImage');
        const basePreview = document.getElementById('baseImagePreview');
        const basePlaceholder = document.getElementById('baseImagePlaceholder');
        const baseImg = document.getElementById('baseImageImg');

        baseInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    baseImg.src = e.target.result;
                    basePreview.classList.remove('hidden');
                    basePlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Generate button event listener
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const baseImageFile = document.getElementById('baseImage').files[0];
            const prompt = document.getElementById('Prompt').value;
            
            if (!baseImageFile) {
                alert('Please upload a base image');
                return;
            }
            if (!prompt.trim()) {
                alert('Please enter a prompt');
                return;
            }
            
            const formData = new FormData();
            formData.append('base_image', baseImageFile);
            formData.append('prompt', prompt);
            formData.append('max_sequence_length', document.getElementById('maxSequenceLength').value);
            formData.append('true_cfg', document.getElementById('cfgScale').value);
            formData.append('timestep_to_start_cfg', document.getElementById('timestepToStartCfg').value);
            formData.append('num_inference_steps', document.getElementById('numStep').value);
            formData.append('width', document.getElementById('width').value);
            formData.append('height', document.getElementById('height').value);
            formData.append('guidance_scale', document.getElementById('guidanceScale').value);
            formData.append('start_step', document.getElementById('startStep').value);
            formData.append('id_weight', document.getElementById('idWeightScale').value);

            const seedValue = document.getElementById('generateSeed').value;
            if (seedValue && seedValue !== '-1') {
                formData.append('seed', seedValue);
            }
            
            try {
                const response = await fetch(`/img2img`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok) {
                    startJobPolling(result.job_id);
                } else {
                    throw new Error(result.detail || 'Generation failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
        
        // Job polling function
        function startJobPolling(jobId) {
            currentJobs.add(jobId);
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('noResults').classList.add('hidden');
            
            const poll = async () => {
                try {
                    const response = await fetch(`/job/${jobId}`);
                    const job = await response.json();
                    
                    updateProgressBar(job.progress * 100);
                    document.getElementById('progressText').textContent = job.status;
                    
                    if (job.status === 'completed') {
                        currentJobs.delete(jobId);
                        document.getElementById('progressSection').classList.add('hidden');
                        addResult(job.result_url, jobId, job.seed || 'N/A');
                        updateJobHistory();
                    } else if (job.status === 'failed') {
                        currentJobs.delete(jobId);
                        document.getElementById('progressSection').classList.add('hidden');
                        alert('Job failed: ' + (job.error_message || 'Unknown error'));
                        updateJobHistory();
                    } else {
                        setTimeout(poll, 1000);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    setTimeout(poll, 2000);
                }
            };
            
            poll();
        }
        
        function updateProgressBar(progress) {
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function addResult(imageUrl, jobId, seedValue) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card p-4';
            resultCard.innerHTML = `
                <img src="${imageUrl}" alt="Generated Image" class="w-full rounded-xl mb-4 shadow-lg">
                <div class="text-gray-700 text-sm mb-3 font-medium">Seed: ${seedValue}</div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="downloadImage('${imageUrl}', 'result_${jobId}.png')" 
                            class="btn-secondary py-2 px-3 text-sm">
                        üì• Download
                    </button>
                    <button onclick="useAsBase('${imageUrl}')" 
                            class="btn-secondary py-2 px-3 text-sm">
                        üîÑ Use as Base
                    </button>
                </div>
            `;
            
            // Insert at the beginning
            resultsContainer.insertBefore(resultCard, resultsContainer.firstChild);
            
            // Remove excess results (keep only 4 max)
            const resultCards = resultsContainer.querySelectorAll('.result-card');
            if (resultCards.length > 4) {
                resultCards[resultCards.length - 1].remove();
            }
        }
        
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function useAsBase(imageUrl) {
            fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    const file = new File([blob], 'base_image.png', { type: 'image/png' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    
                    document.getElementById('baseImage').files = dataTransfer.files;
                    document.getElementById('baseImage').dispatchEvent(new Event('change'));
                })
                .catch(error => {
                    console.error('Error using image as base:', error);
                    alert('Failed to use image as base');
                });
        }
        
        async function updateJobHistory() {
            try {
                const response = await fetch(`/jobs`);
                const data = await response.json();
                
                const jobHistory = document.getElementById('jobHistory');
                jobHistory.innerHTML = '';
                
                let jobs = [];
                if (Array.isArray(data)) {
                    jobs = data;
                } else if (data.jobs && Array.isArray(data.jobs)) {
                    jobs = data.jobs;
                } else if (typeof data === 'object') {
                    jobs = Object.values(data);
                }
                
                if (jobs.length === 0) {
                    jobHistory.innerHTML = '<div class="text-gray-500 text-center py-4">No jobs yet</div>';
                    return;
                }
                
                jobs.forEach(job => {
                    const jobElement = document.createElement('div');
                    jobElement.className = 'glass-card-secondary p-3';
                    
                    const jobId = job.job_id || job.id || 'Unknown';
                    const status = job.status || 'Unknown';
                    const createdAt = job.created_at || job.timestamp || new Date().toISOString();
                    
                    jobElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-gray-800 font-semibold text-sm">${jobId.toString().substr(0, 8)}...</div>
                                <div class="text-gray-600 text-xs">${status}</div>
                            </div>
                            <div class="text-gray-500 text-xs">
                                ${new Date(createdAt).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                    jobHistory.appendChild(jobElement);
                });
            } catch (error) {
                console.error('Failed to update job history:', error);
                const jobHistory = document.getElementById('jobHistory');
                jobHistory.innerHTML = '<div class="text-gray-500 text-center py-4">Failed to load history</div>';
            }
        }
        
        // Initialize
        updateJobHistory();
        
        // Check API health on load
        fetch(`/health`)
            .then(response => response.json())
            .then(data => {
                if (!data.pipelines_loaded) {
                    alert('Warning: AI models are still loading. Please wait a moment before generating images.');
                }
            })
            .catch(error => {
                alert('Cannot connect to API server. Please make sure the backend is running on http://localhost:8888');
            });
    </script>
</body>
</html>